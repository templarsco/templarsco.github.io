<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | Lightweight</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/2.0.0/iconify-icon.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              bg: "#0A0A0A",
              surface: "#111111",
              accent: "#22C55E",
              borderline: "rgba(255,255,255,0.05)",
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
              mono: ["JetBrains Mono", "monospace"],
            },
          },
        },
      };
    </script>
    <style>
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .chart-bar {
        transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      }
    </style>
  </head>
  <body
    class="bg-bg text-gray-300 font-sans antialiased min-h-screen flex flex-col selection:bg-accent/30 selection:text-white"
  >
    <!-- Navbar -->
    <nav
      class="border-b border-borderline bg-surface/80 backdrop-blur-md sticky top-0 z-50"
    >
      <div
        class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between"
      >
        <div class="flex items-center gap-6">
          <a
            href="/"
            class="flex items-center gap-2 text-white font-semibold text-lg hover:text-accent transition-colors"
          >
            <iconify-icon
              icon="solar:bolt-circle-bold"
              class="text-accent text-2xl"
            ></iconify-icon>
            Lightweight
          </a>
          <div class="hidden md:flex items-center gap-4 text-sm font-medium">
            <a href="dashboard.html" class="text-accent">Dashboard</a>
            <a
              href="docs.html"
              class="text-gray-400 hover:text-white transition-colors"
              >Docs</a
            >
            <a
              href="#models"
              class="text-gray-400 hover:text-white transition-colors"
              >Models</a
            >
          </div>
        </div>
        <div class="flex items-center gap-4">
          <div
            class="flex items-center gap-2 bg-bg px-3 py-1.5 rounded-full border border-borderline"
          >
            <img
              id="nav-avatar"
              src=""
              alt="Avatar"
              class="w-6 h-6 rounded-full hidden border border-borderline"
            />
            <span
              id="nav-username"
              class="text-sm font-medium text-white hidden"
            ></span>
          </div>
          <button
            id="logout-btn"
            class="text-sm text-gray-400 hover:text-white transition-colors flex items-center gap-1"
          >
            <iconify-icon icon="solar:logout-2-linear"></iconify-icon> Logout
          </button>
        </div>
      </div>
    </nav>

    <!-- Main -->
    <main
      class="flex-1 max-w-[1200px] mx-auto w-full px-4 sm:px-6 lg:px-8 py-8 space-y-8"
    >
      <!-- Welcome Banner -->
      <div
        class="flex flex-col sm:flex-row sm:items-center justify-between gap-4"
      >
        <div>
          <h1
            class="text-3xl font-bold text-white flex items-center gap-3 flex-wrap"
          >
            Welcome back, <span id="welcome-username"></span>
            <span
              id="welcome-tier"
              class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-accent/10 text-accent border border-accent/20 hidden uppercase tracking-wider"
            ></span>
          </h1>
          <p class="text-gray-400 mt-2">
            Manage your API keys, usage, and connected models.
          </p>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
        <!-- API Key Card (Col Span 2) -->
        <div
          class="bg-surface border border-borderline rounded-xl p-6 lg:col-span-2 flex flex-col justify-between shadow-lg shadow-black/20"
        >
          <div>
            <div class="flex items-center justify-between mb-4">
              <h2
                class="text-lg font-semibold text-white flex items-center gap-2"
              >
                <iconify-icon
                  icon="solar:key-linear"
                  class="text-accent text-xl"
                ></iconify-icon>
                API Key
              </h2>
              <button
                id="regenerate-btn"
                class="text-sm text-gray-400 hover:text-red-400 flex items-center gap-1 transition-colors"
              >
                <iconify-icon icon="solar:refresh-circle-linear"></iconify-icon>
                Regenerate
              </button>
            </div>
            <div
              class="flex items-center gap-2 bg-bg border border-borderline rounded-lg p-3"
            >
              <code
                id="api-key-display"
                class="font-mono text-white text-sm flex-1 tracking-wider"
                >lw-••••••••••••••••••••</code
              >
              <button
                id="copy-key-btn"
                class="text-gray-400 hover:text-white p-2 rounded hover:bg-surface transition-colors flex items-center justify-center"
              >
                <iconify-icon
                  icon="solar:copy-linear"
                  class="text-lg"
                ></iconify-icon>
              </button>
            </div>
          </div>
          <div class="mt-6">
            <p class="text-sm text-gray-400 mb-2">
              Use this key to authenticate your requests:
            </p>
            <div class="relative group">
              <pre
                class="font-mono text-xs bg-bg p-4 rounded-lg border border-borderline overflow-x-auto text-gray-400"
              ><span class="text-accent">export</span> OPENAI_API_KEY=<span class="text-white" id="env-api-key">"lw-your-key"</span>
<span class="text-accent">export</span> OPENAI_BASE_URL=<span class="text-white">"https://api.lightweight.one/v1"</span></pre>
              <button
                id="copy-env-btn"
                class="absolute top-2 right-2 p-1.5 rounded bg-surface border border-borderline text-gray-400 opacity-0 group-hover:opacity-100 transition-all hover:text-white hover:bg-bg flex items-center justify-center"
              >
                <iconify-icon icon="solar:copy-linear"></iconify-icon>
              </button>
            </div>
          </div>
        </div>

        <!-- Account Info -->
        <div
          class="bg-surface border border-borderline rounded-xl p-6 flex flex-col shadow-lg shadow-black/20"
        >
          <h2
            class="text-lg font-semibold text-white flex items-center gap-2 mb-6"
          >
            <iconify-icon
              icon="solar:user-id-linear"
              class="text-accent text-xl"
            ></iconify-icon>
            Account Info
          </h2>
          <div class="space-y-4 flex-1">
            <div
              class="flex justify-between items-center pb-4 border-b border-borderline"
            >
              <span class="text-gray-400 text-sm">Current Tier</span>
              <div class="flex items-center gap-2">
                <span
                  id="account-og"
                  class="px-2 py-0.5 rounded text-xs font-medium bg-purple-500/10 text-purple-400 border border-purple-500/20 hidden uppercase tracking-wider"
                  >OG</span
                >
                <span
                  id="account-tier"
                  class="px-2.5 py-0.5 rounded text-xs font-medium bg-bg border border-borderline text-white uppercase tracking-wider"
                  >Loading...</span
                >
              </div>
            </div>
            <div
              class="flex justify-between items-center pb-4 border-b border-borderline"
            >
              <span class="text-gray-400 text-sm">Period Started</span>
              <span id="account-period" class="text-sm text-white font-mono"
                >--</span
              >
            </div>
            <div
              id="upgrade-prompt"
              class="hidden rounded-lg bg-accent/5 border border-accent/20 p-4 mt-4"
            >
              <p class="text-sm text-white font-medium mb-1">
                Need more power?
              </p>
              <p class="text-xs text-gray-400 mb-3">
                Upgrade your tier to unlock higher limits and more models.
              </p>
              <button
                class="w-full bg-bg hover:bg-accent/10 text-accent border border-accent/30 transition-colors py-2 rounded text-sm font-medium"
              >
                Request Upgrade
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Usage Overview -->
      <h3
        class="text-xl font-semibold text-white flex items-center gap-2 mt-8 border-t border-borderline pt-8"
      >
        <iconify-icon
          icon="solar:chart-square-linear"
          class="text-accent"
        ></iconify-icon>
        Usage Overview
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Tokens Card -->
        <div
          class="bg-surface border border-borderline rounded-xl p-6 shadow-lg shadow-black/20"
        >
          <div class="flex justify-between items-start mb-2">
            <span class="text-gray-400 text-sm font-medium">Tokens Used</span>
            <iconify-icon
              icon="solar:database-linear"
              class="text-gray-500 text-lg"
            ></iconify-icon>
          </div>
          <div class="flex items-baseline gap-2 mb-4 mt-2">
            <span
              id="tokens-used"
              class="text-3xl font-bold text-white font-mono"
              >0</span
            >
            <span class="text-sm text-gray-500 font-mono"
              >/ <span id="tokens-limit">0</span></span
            >
          </div>
          <div class="w-full h-2 bg-bg rounded-full overflow-hidden">
            <div
              id="token-progress-bar"
              class="h-full bg-accent transition-all duration-700 w-0"
            ></div>
          </div>
          <p
            id="tokens-remaining"
            class="text-xs text-gray-500 mt-2 text-right font-mono"
          >
            0 remaining
          </p>
        </div>

        <!-- Requests Card -->
        <div
          class="bg-surface border border-borderline rounded-xl p-6 shadow-lg shadow-black/20"
        >
          <div class="flex justify-between items-start mb-2">
            <span class="text-gray-400 text-sm font-medium">Requests</span>
            <iconify-icon
              icon="solar:transfer-horizontal-linear"
              class="text-gray-500 text-lg"
            ></iconify-icon>
          </div>
          <div class="flex items-baseline gap-2 mt-2">
            <span
              id="total-requests"
              class="text-3xl font-bold text-white font-mono"
              >0</span
            >
          </div>
          <p class="text-xs text-gray-500 mt-3">
            Total successful requests this period
          </p>
        </div>

        <!-- RPM Card -->
        <div
          class="bg-surface border border-borderline rounded-xl p-6 shadow-lg shadow-black/20"
        >
          <div class="flex justify-between items-start mb-2">
            <span class="text-gray-400 text-sm font-medium">Rate Limit</span>
            <iconify-icon
              icon="solar:stopwatch-linear"
              class="text-gray-500 text-lg"
            ></iconify-icon>
          </div>
          <div class="flex items-baseline gap-2 mt-2">
            <span id="rpm-limit" class="text-3xl font-bold text-white font-mono"
              >0</span
            >
            <span class="text-sm text-gray-500">RPM</span>
          </div>
          <p class="text-xs text-gray-500 mt-3">
            Maximum requests per minute allowed
          </p>
        </div>
      </div>

      <!-- Charts and Tables -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Usage Chart -->
        <div
          class="bg-surface border border-borderline rounded-xl p-6 lg:col-span-1 shadow-lg shadow-black/20 flex flex-col"
        >
          <h3 class="text-sm font-semibold text-white mb-6">
            Top Models by Tokens
          </h3>
          <div
            id="chart-container"
            class="flex-1 flex items-end gap-3 h-[220px] min-h-[220px] mt-auto relative border-b border-borderline/50 pb-2 pt-8 overflow-hidden"
          >
            <!-- Chart bars injected here -->
            <div
              class="w-full h-full flex items-center justify-center absolute inset-0 text-sm text-gray-500"
              id="chart-empty"
            >
              No usage data yet
            </div>
          </div>
        </div>

        <!-- Breakdown Table -->
        <div
          class="bg-surface border border-borderline rounded-xl p-0 lg:col-span-2 shadow-lg shadow-black/20 overflow-hidden flex flex-col"
        >
          <div class="p-6 border-b border-borderline">
            <h3 class="text-sm font-semibold text-white">Usage Breakdown</h3>
          </div>
          <div class="overflow-x-auto flex-1">
            <table class="w-full text-left border-collapse min-w-[600px]">
              <thead>
                <tr
                  class="bg-bg/50 border-b border-borderline text-xs uppercase tracking-wider text-gray-500"
                >
                  <th class="p-4 font-medium">Model</th>
                  <th class="p-4 font-medium text-right">Requests</th>
                  <th class="p-4 font-medium text-right">Input</th>
                  <th class="p-4 font-medium text-right">Output</th>
                  <th class="p-4 font-medium text-right text-white">Total</th>
                </tr>
              </thead>
              <tbody
                id="usage-table-body"
                class="text-sm divide-y divide-borderline"
              >
                <!-- Table rows injected here -->
                <tr>
                  <td colspan="5" class="p-8 text-center text-gray-500">
                    Loading data...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Models Grid -->
      <h3
        id="models"
        class="text-xl font-semibold text-white flex items-center gap-2 mt-12 border-t border-borderline pt-8"
      >
        <iconify-icon
          icon="solar:cpu-linear"
          class="text-accent"
        ></iconify-icon>
        Available Models
      </h3>
      <p class="text-sm text-gray-400 mt-1">
        Models accessible with your current Lightweight API key.
      </p>

      <div id="models-container" class="space-y-10 mt-6">
        <div class="text-center py-12 text-gray-500">Loading models...</div>
        <!-- Model groups injected here -->
      </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-borderline bg-surface mt-16">
      <div
        class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8 py-8 flex flex-col md:flex-row items-center justify-between gap-4"
      >
        <div class="flex items-center gap-2 text-white font-semibold">
          <iconify-icon
            icon="solar:bolt-circle-bold"
            class="text-accent text-xl"
          ></iconify-icon>
          Lightweight
        </div>
        <p class="text-sm text-gray-500">
          © <span id="year"></span> Lightweight. A universal AI gateway.
        </p>
        <div class="flex gap-4 text-sm font-medium">
          <a href="#" class="text-gray-400 hover:text-white transition-colors"
            >Terms</a
          >
          <a href="#" class="text-gray-400 hover:text-white transition-colors"
            >Privacy</a
          >
        </div>
      </div>
    </footer>

    <!-- Modals -->
    <div
      id="regenerate-modal"
      class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300"
    >
      <div
        class="bg-surface border border-borderline rounded-xl p-6 max-w-md w-full shadow-2xl transform scale-95 transition-transform duration-300"
        id="regenerate-modal-content"
      >
        <h3 class="text-xl font-bold text-white mb-2 flex items-center gap-2">
          <iconify-icon
            icon="solar:danger-triangle-linear"
            class="text-yellow-500"
          ></iconify-icon>
          Regenerate API Key?
        </h3>
        <p class="text-gray-400 text-sm mb-6">
          This will immediately invalidate your current API key. Any
          applications using it will lose access until updated with the new key.
        </p>
        <div class="flex items-center justify-end gap-3">
          <button
            id="cancel-regen-btn"
            class="px-4 py-2 rounded-lg text-sm font-medium text-gray-300 hover:text-white hover:bg-bg transition-colors"
          >
            Cancel
          </button>
          <button
            id="confirm-regen-btn"
            class="px-4 py-2 rounded-lg text-sm font-medium bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500 hover:text-white transition-all"
          >
            Yes, Regenerate
          </button>
        </div>
      </div>
    </div>

    <!-- Logic -->
    <script>
      (function () {
        const API_BASE = "https://api.lightweight.one";

        // Set Year
        document.getElementById("year").textContent = new Date().getFullYear();

        // Setup Auth & User Info
        const apiKey = localStorage.getItem("lw_api_key");
        let userStr = localStorage.getItem("lw_user");

        if (!apiKey) {
          window.location.href = "login.html";
          return;
        }

        // Display Keys
        const apiKeyDisplay = document.getElementById("api-key-display");
        apiKeyDisplay.textContent =
          "lw-" + "*".repeat(24) + (apiKey.length > 4 ? apiKey.slice(-4) : "");

        const envKeyDisplay = document.getElementById("env-api-key");
        envKeyDisplay.textContent = `"${apiKey}"`;

        const terminalCode = `export OPENAI_API_KEY="${apiKey}"\nexport OPENAI_BASE_URL="${API_BASE}/v1"`;

        let user = { login: "User", tier: "Free", og: false };
        try {
          if (userStr) user = JSON.parse(userStr);
        } catch (e) {}

        // Populate UI with User Info
        document.getElementById("welcome-username").textContent = user.login;
        document.getElementById("nav-username").textContent = user.login;
        document.getElementById("nav-username").classList.remove("hidden");

        if (user.avatar_url) {
          const avatarImg = document.getElementById("nav-avatar");
          avatarImg.src = user.avatar_url;
          avatarImg.classList.remove("hidden");
        }

        if (user.tier) {
          const welcomeTier = document.getElementById("welcome-tier");
          welcomeTier.textContent = user.tier;
          welcomeTier.classList.remove("hidden");
          document.getElementById("account-tier").textContent = user.tier;
          if (
            user.tier.toLowerCase() !== "pro" &&
            user.tier.toLowerCase() !== "enterprise"
          ) {
            document
              .getElementById("upgrade-prompt")
              .classList.remove("hidden");
          }
        }

        if (user.og) {
          document.getElementById("account-og").classList.remove("hidden");
          // Duplicate badge on welcome
          const ogBadge = document.createElement("span");
          ogBadge.className =
            "px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-500/10 text-purple-400 border border-purple-500/20 uppercase tracking-wider";
          ogBadge.textContent = "OG";
          document.getElementById("welcome-tier").after(ogBadge);
        }

        // Interactions

        // Logout
        document.getElementById("logout-btn").addEventListener("click", () => {
          localStorage.removeItem("lw_api_key");
          localStorage.removeItem("lw_user");
          window.location.href = "login.html";
        });

        // Copy Key
        document
          .getElementById("copy-key-btn")
          .addEventListener("click", async function () {
            try {
              await navigator.clipboard.writeText(apiKey);
              const icon = this.querySelector("iconify-icon");
              icon.setAttribute("icon", "solar:check-circle-linear");
              icon.classList.add("text-accent");
              setTimeout(() => {
                icon.setAttribute("icon", "solar:copy-linear");
                icon.classList.remove("text-accent");
              }, 2000);
            } catch (e) {
              console.error("Failed to copy", e);
            }
          });

        // Copy Env
        document
          .getElementById("copy-env-btn")
          .addEventListener("click", async function () {
            try {
              await navigator.clipboard.writeText(terminalCode);
              const icon = this.querySelector("iconify-icon");
              icon.setAttribute("icon", "solar:check-circle-linear");
              icon.classList.add("text-accent");
              setTimeout(() => {
                icon.setAttribute("icon", "solar:copy-linear");
                icon.classList.remove("text-accent");
              }, 2000);
            } catch (e) {
              console.error("Failed to copy", e);
            }
          });

        // Regenerate Modal
        const modal = document.getElementById("regenerate-modal");
        const modalContent = document.getElementById(
          "regenerate-modal-content",
        );

        document
          .getElementById("regenerate-btn")
          .addEventListener("click", () => {
            modal.classList.remove("hidden");
            // trigger reflow
            void modal.offsetWidth;
            modal.classList.remove("opacity-0");
            modalContent.classList.remove("scale-95");
          });

        const closeModal = () => {
          modal.classList.add("opacity-0");
          modalContent.classList.add("scale-95");
          setTimeout(() => modal.classList.add("hidden"), 300);
        };

        document
          .getElementById("cancel-regen-btn")
          .addEventListener("click", closeModal);
        modal.addEventListener("click", (e) => {
          if (e.target === modal) closeModal();
        });

        document
          .getElementById("confirm-regen-btn")
          .addEventListener("click", async () => {
            const btn = document.getElementById("confirm-regen-btn");
            btn.innerHTML =
              '<iconify-icon icon="line-md:loading-loop"></iconify-icon> Processing...';
            // Mock regenerate delay
            setTimeout(() => {
              alert("API Key regenerated (mock implementation).");
              closeModal();
              btn.innerHTML = "Yes, Regenerate";
            }, 1000);
          });

        // Utilities
        const formatNumber = (num) =>
          num <= 0 || num == null ? '∞' : new Intl.NumberFormat('en-US').format(num);
        const formatDate = (ts) => {
          if (!ts || ts <= 0) return 'Not started';
          const d = new Date(typeof ts === 'number' && ts < 1e12 ? ts * 1000 : ts);
          return d.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
          });
        };

        // Fetch Usage
        async function fetchUsage() {
          try {
            const res = await fetch(`${API_BASE}/v1/usage`, {
              headers: { Authorization: `Bearer ${apiKey}` },
            });

            if (!res.ok) throw new Error("Failed to fetch usage");

            const data = await res.json();
            renderUsage(data);
          } catch (e) {
            console.error(e);
            // Provide fallback UI for when real API fails (preview mode / testing)
            renderUsage({
              tokens_used: 124500,
              tokens_limit: 1000000,
              tokens_remaining: 875500,
              rpm_limit: 100,
              tier: user.tier || "Pro",
              period_start: new Date().toISOString(),
              models: [
                {
                  model: "gpt-4o",
                  input: 45000,
                  output: 25000,
                  total: 70000,
                  requests: 120,
                },
                {
                  model: "claude-3-5-sonnet-20241022",
                  input: 20000,
                  output: 14000,
                  total: 34000,
                  requests: 45,
                },
                {
                  model: "gemini-1.5-pro",
                  input: 5000,
                  output: 10000,
                  total: 15000,
                  requests: 12,
                },
                {
                  model: "meta-llama-3.1-70b-instruct",
                  input: 3000,
                  output: 1500,
                  total: 4500,
                  requests: 8,
                },
                {
                  model: "mistral-large-latest",
                  input: 500,
                  output: 500,
                  total: 1000,
                  requests: 2,
                },
              ],
            });
          }
        }

        function renderUsage(data) {
          // Period Update
          if (data.period_start) {
            document.getElementById("account-period").textContent = formatDate(
              data.period_start,
            );
          }
          if (data.tier && data.tier !== user.tier) {
            document.getElementById("account-tier").textContent = data.tier;
          }

          // Tokens Card
          document.getElementById("tokens-used").textContent = formatNumber(
            data.tokens_used,
          );
          document.getElementById('tokens-limit').textContent = data.tokens_limit <= 0 || data.tokens_limit == null ? '∞' : formatNumber(data.tokens_limit);
          const remaining = data.tokens_limit <= 0 || data.tokens_limit == null ? '∞' : formatNumber(data.tokens_remaining || data.tokens_limit - data.tokens_used);
          document.getElementById('tokens-remaining').textContent = `${remaining} remaining`;

          // Progress Bar
          const pct = data.tokens_limit <= 0 || data.tokens_limit == null ? 0 : Math.min(
            ((data.tokens_used || 0) / Math.max(data.tokens_limit, 1)) * 100,
            100,
          );
          const pb = document.getElementById("token-progress-bar");
          setTimeout(() => {
            pb.style.width = `${pct}%`;
            if (pct > 90)
              pb.className = "h-full transition-all duration-700 bg-red-500";
            else if (pct > 75)
              pb.className = "h-full transition-all duration-700 bg-yellow-500";
            else pb.className = "h-full transition-all duration-700 bg-accent";
          }, 100);

          // RPM
          document.getElementById("rpm-limit").textContent = formatNumber(
            data.rpm_limit,
          );

          // Models processing
          let models = Array.isArray(data.models) ? data.models : [];
          models.sort((a, b) => (b.total || 0) - (a.total || 0));

          // Total requests
          const totalReq = models.reduce(
            (acc, m) => acc + (m.requests || 0),
            0,
          );
          document.getElementById("total-requests").textContent =
            formatNumber(totalReq);

          // Chart (Top 5)
          const chartContainer = document.getElementById("chart-container");
          const emptyMsg = document.getElementById("chart-empty");
          if (models.length === 0) {
            emptyMsg.classList.remove("hidden");
          } else {
            emptyMsg.classList.add("hidden");
            const top5 = models.slice(0, 5);
            const maxTotal = top5[0].total || 1;

            let chartHTML = "";
            top5.forEach((m) => {
              const heightPct = Math.max((m.total / maxTotal) * 100, 5); // min 5% height
              const labelTokens =
                m.total > 1000 ? (m.total / 1000).toFixed(1) + "k" : m.total;
              const shortModel = m.model;

              chartHTML += `
                        <div class="flex-1 flex flex-col items-center group relative h-full min-w-0">
                            <div class="flex-1 w-full flex items-end relative">
                                <div class="w-full bg-accent/20 group-hover:bg-accent rounded-t-sm chart-bar relative" style="height: 0%" data-target-height="${heightPct}%">
                                    <div class="opacity-0 group-hover:opacity-100 absolute -top-8 left-1/2 -translate-x-1/2 bg-surface border border-borderline px-2 py-1 rounded text-xs text-white whitespace-nowrap z-10 shadow-lg pointer-events-none transition-opacity">
                                        ${labelTokens} tokens
                                    </div>
                                </div>
                            </div>
                            <div class="mt-1 text-[10px] sm:text-xs text-gray-500 w-full text-center truncate" title="${m.model}">${shortModel}</div>
                        </div>`;
            });
            chartContainer.innerHTML = chartHTML;

            // Animate chart bars
            setTimeout(() => {
              chartContainer.querySelectorAll(".chart-bar").forEach((bar) => {
                bar.style.height = bar.getAttribute("data-target-height");
              });
            }, 50);
          }

          // Table
          const tbody = document.getElementById("usage-table-body");
          if (models.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-500">No usage data found. Make some API requests!</td></tr>`;
          } else {
            tbody.innerHTML = models
              .map(
                (m) => `
                        <tr class="hover:bg-bg/50 transition-colors">
                            <td class="p-4 font-mono text-xs text-white whitespace-nowrap">${m.model}</td>
                            <td class="p-4 font-mono text-xs text-gray-400 text-right">${formatNumber(m.requests)}</td>
                            <td class="p-4 font-mono text-xs text-gray-400 text-right">${formatNumber(m.input)}</td>
                            <td class="p-4 font-mono text-xs text-gray-400 text-right">${formatNumber(m.output)}</td>
                            <td class="p-4 font-mono text-xs text-accent text-right font-medium">${formatNumber(m.total)}</td>
                        </tr>
                    `,
              )
              .join("");
          }
        }

        // Fetch Models
        function getProvider(modelId) {
          const id = modelId.toLowerCase();
          if (
            id.includes("gpt-") ||
            id.includes("o1-") ||
            id.includes("o3-") ||
            id.includes("dall-e") ||
            id.includes("text-embedding")
          )
            return { name: "OpenAI", icon: "solar:magic-stick-3-linear" };
          if (id.includes("claude"))
            return { name: "Anthropic", icon: "solar:brain-linear" };
          if (id.includes("gemini"))
            return { name: "Google", icon: "solar:star-circle-linear" };
          if (id.includes("meta") || id.includes("llama"))
            return { name: "Meta", icon: "solar:infinity-linear" };
          if (id.includes("mistral") || id.includes("mixtral"))
            return { name: "Mistral", icon: "solar:wind-linear" };
          if (id.includes("cohere") || id.includes("command"))
            return { name: "Cohere", icon: "solar:layers-linear" };
          if (id.includes("deepseek"))
            return { name: "DeepSeek", icon: "solar:target-linear" };
          if (id.includes("phi") || id.includes("wizardlm"))
            return { name: "Microsoft", icon: "solar:window-frame-linear" };
          if (id.includes("grok"))
            return { name: "xAI", icon: "solar:close-circle-linear" };
          return { name: "Other", icon: "solar:box-linear" };
        }

        async function fetchModels() {
          try {
            const res = await fetch(`${API_BASE}/v1/models`);
            if (!res.ok) throw new Error("Failed to fetch models");
            const data = await res.json();
            renderModels(data.data || []);
          } catch (e) {
            console.error(e);
            // Fallback models for preview if backend is unreachable
            renderModels([
              { id: "gpt-4o", context_window: 128000, preview: false },
              { id: "o1-preview", context_window: 128000, preview: true },
              {
                id: "claude-3-5-sonnet-20241022",
                context_window: 200000,
                preview: false,
              },
              { id: "gemini-1.5-pro", context_window: 2000000, preview: false },
              {
                id: "meta-llama-3.1-405b-instruct",
                context_window: 128000,
                preview: false,
              },
              {
                id: "mistral-large-latest",
                context_window: 131000,
                preview: false,
              },
              { id: "deepseek-chat", context_window: 128000, preview: false },
            ]);
          }
        }

        function renderModels(models) {
          const container = document.getElementById("models-container");
          if (!models || models.length === 0) {
            container.innerHTML = `<div class="text-center py-12 text-gray-500">No models available.</div>`;
            return;
          }

          // Group
          const grouped = {};
          models.forEach((m) => {
            const p = getProvider(m.id);
            if (!grouped[p.name])
              grouped[p.name] = { icon: p.icon, models: [] };
            grouped[p.name].models.push(m);
          });

          // Generate HTML
          let html = "";
          // Standard order
          const order = [
            "OpenAI",
            "Anthropic",
            "Google",
            "Meta",
            "Mistral",
            "Cohere",
            "DeepSeek",
            "Microsoft",
            "xAI",
            "Other",
          ];
          const sortedProviders = Object.keys(grouped).sort((a, b) => {
            const idxA = order.indexOf(a) !== -1 ? order.indexOf(a) : 99;
            const idxB = order.indexOf(b) !== -1 ? order.indexOf(b) : 99;
            return idxA - idxB;
          });

          for (const providerName of sortedProviders) {
            const group = grouped[providerName];
            // Sort models alphabetically inside group
            group.models.sort((a, b) => a.id.localeCompare(b.id));

            let cards = group.models
              .map(
                (m) => `
                        <div class="bg-surface border border-borderline rounded-lg p-4 hover:border-gray-500 transition-colors flex flex-col justify-between group cursor-default">
                            <div>
                                <div class="flex items-start justify-between gap-2 mb-2">
                                    <h4 class="text-sm font-mono text-white break-all group-hover:text-accent transition-colors">${m.id}</h4>
                                    ${m.preview ? `<span class="px-1.5 py-0.5 rounded text-[10px] font-medium bg-yellow-500/10 text-yellow-500 border border-yellow-500/20 uppercase tracking-wider shrink-0">Preview</span>` : ""}
                                </div>
                            </div>
                            <div class="mt-4 flex items-center gap-1.5 text-xs text-gray-500">
                                <iconify-icon icon="solar:maximize-square-minimalistic-linear" class="text-sm"></iconify-icon>
                                ${m.context_window ? formatNumber(m.context_window) + " context" : "Unknown context"}
                            </div>
                        </div>
                    `,
              )
              .join("");

            html += `
                        <div class="mb-8">
                            <h4 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2 border-b border-borderline pb-2">
                                <iconify-icon icon="${group.icon}" class="text-lg"></iconify-icon> ${providerName}
                            </h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                ${cards}
                            </div>
                        </div>
                    `;
          }

          container.innerHTML = html;
        }

        // Init
        fetchUsage();
        fetchModels();
      })();
    </script>
  </body>
</html>
